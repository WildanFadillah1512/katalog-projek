import express from 'express';
import cors from 'cors';
import db from './database.js';

const app = express();
const port = 3000;

app.use(cors({
    origin: 'http://localhost:5173',
    credentials: true
}));
app.use(express.json());

// --- Auth Routes ---

app.post('/api/auth/register', (req, res) => {
    const { name, email, password } = req.body;
    // In production, hash password here
    const sql = 'INSERT INTO users (name, email, password, role) VALUES (?, ?, ?, ?)';
    db.run(sql, [name, email, password, 'free'], function (err) {
        if (err) {
            return res.status(400).json({ error: err.message });
        }
        res.json({
            message: 'User registered',
            user: { id: this.lastID, name, email, role: 'free' },
            token: 'mock-jwt-token-' + this.lastID // Mock token
        });
    });
});

app.post('/api/auth/login', (req, res) => {
    const { email, password } = req.body;
    const sql = 'SELECT * FROM users WHERE email = ? AND password = ?';
    db.get(sql, [email, password], (err, row) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        if (row) {
            res.json({
                message: 'Login successful',
                user: { id: row.id, name: row.name, email: row.email, role: row.role },
                token: 'mock-jwt-token-' + row.id
            });
        } else {
            res.status(401).json({ message: 'Invalid credentials' });
        }
    });
});

app.get('/api/auth/me', (req, res) => {
    const token = req.headers.authorization;
    if (!token) return res.status(401).json({ message: 'No token' });

    // Mock token verification (extract ID from mock-jwt-token-ID)
    const userId = token.replace('Bearer ', '').split('-').pop();

    const sql = 'SELECT id, name, email, role FROM users WHERE id = ?';
    db.get(sql, [userId], (err, row) => {
        if (err || !row) return res.status(401).json({ message: 'Invalid token' });
        res.json({ user: row });
    });
});

// Middleware for user authentication
function requireAuth(req, res, next) {
    const token = req.headers.authorization;
    if (!token) {
        return res.status(401).json({ message: 'No token provided' });
    }

    const userId = token.replace('Bearer ', '').split('-').pop();
    const sql = 'SELECT * FROM users WHERE id = ?';
    
    db.get(sql, [userId], (err, row) => {
        if (err || !row) {
            return res.status(401).json({ message: 'Invalid token' });
        }
        req.user = row;
        next();
    });
}

// Middleware for admin authentication
function requireAdmin(req, res, next) {
    const token = req.headers.authorization;
    if (!token) {
        return res.status(401).json({ message: 'No token provided' });
    }

    const userId = token.replace('Bearer ', '').split('-').pop();
    const sql = 'SELECT * FROM users WHERE id = ? AND role = "admin"';

    db.get(sql, [userId], (err, row) => {
        if (err || !row) {
            return res.status(403).json({ message: 'Admin access required' });
        }
        req.user = row;
        next();
    });
}

// --- Project Routes ---

app.get('/api/projects', (req, res) => {
    const sql = 'SELECT * FROM projects';
    db.all(sql, [], (err, rows) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        // Parse JSON fields
        const projects = rows.map(p => ({
            ...p,
            techStack: JSON.parse(p.techStack || '[]'),
            featured: !!p.featured
        }));
        res.json(projects);
    });
});

app.get('/api/projects/:slug', (req, res) => {
    const sql = 'SELECT * FROM projects WHERE slug = ?';
    db.get(sql, [req.params.slug], (err, row) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        if (row) {
            const project = {
                ...row,
                techStack: JSON.parse(row.techStack || '[]'),
                featured: !!row.featured,
                // Mock complex data enrichment
                gallery: [row.thumbnail, 'https://placehold.co/600x400', 'https://placehold.co/600x400'],
                author: { name: 'SmartIndus Team', avatar: 'https://ui-avatars.com/api/?name=SI&background=059669&color=fff', reputation: 98, bio: 'Official Team', totalSales: 100 },
                reviews: [
                    { id: 1, userName: 'DemoUser', date: '2026-01-01', content: 'Great project!', rating: 5 }
                ],
                changelog: [
                    { version: 'v1.0', date: '2026-01-01', changes: ['Initial Release'] }
                ],
                licenses: [
                    { type: 'Personal', price: 0, features: ['Personal Use', 'Non-Commercial'] },
                    { type: 'Commercial', price: 49, features: ['Commercial Use', 'Priority Support'] }
                ]
            };
            res.json(project);
        } else {
            res.status(404).json({ message: 'Project not found' });
        }
    });
});

// --- Commerce Routes ---

app.post('/api/checkout', (req, res) => {
    const { userId, projectId, licenseType, couponId, originalPrice, finalPrice } = req.body;
    const sql = `INSERT INTO licenses (userId, projectId, licenseType, purchaseDate, originalPrice, finalPrice, couponId) 
                 VALUES (?, ?, ?, ?, ?, ?, ?)`;
    const date = new Date().toISOString();

    db.run(sql, [userId, projectId, licenseType, date, originalPrice, finalPrice, couponId], function (err) {
        if (err) {
            return res.status(500).json({ error: err.message });
        }

        // If coupon was used, record the usage
        if (couponId) {
            const usageSQL = `INSERT INTO coupon_usages (couponId, userId, licenseId) VALUES (?, ?, ?)`;
            db.run(usageSQL, [couponId, userId, this.lastID]);

            // Update coupon usage count
            const updateSQL = `UPDATE coupons SET currentUses = currentUses + 1 WHERE id = ?`;
            db.run(updateSQL, [couponId]);
        }

        res.json({ success: true, licenseId: this.lastID });
    });
});

// --- Coupon Routes ---

// Validate coupon
app.post('/api/coupons/validate', requireAuth, (req, res) => {
    const { code, totalAmount } = req.body;
    const now = new Date().toISOString();

    const sql = `SELECT * FROM coupons WHERE code = ? AND isActive = 1 AND validFrom <= ? AND validUntil > ?`;

    db.get(sql, [code, now, now], (err, coupon) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }

        if (!coupon) {
            return res.status(400).json({ message: 'Invalid or expired coupon code' });
        }

        // Check if coupon has usage limit and if it's exceeded
        if (coupon.maxUses && coupon.currentUses >= coupon.maxUses) {
            return res.status(400).json({ message: 'Coupon usage limit exceeded' });
        }

        // Check minimum purchase amount
        if (totalAmount < coupon.minPurchaseAmount) {
            return res.status(400).json({
                message: `Minimum purchase amount of $${coupon.minPurchaseAmount} required`
            });
        }

        // Calculate discount
        let discount;
        if (coupon.discountType === 'percentage') {
            discount = Math.min((totalAmount * coupon.discountValue) / 100, totalAmount);
        } else {
            discount = Math.min(coupon.discountValue, totalAmount);
        }

        res.json({
            isValid: true,
            discount: discount,
            coupon: coupon
        });
    });
});

// --- Admin Coupon Routes ---

// Get all coupons (admin only)
app.get('/api/admin/coupons', requireAdmin, (req, res) => {
    const sql = 'SELECT * FROM coupons ORDER BY createdAt DESC';
    db.all(sql, [], (err, rows) => {
        if (err) {
            return res.status(500).json({ error: err.message });
        }
        res.json(rows);
    });
});

// Create coupon (admin only)
app.post('/api/admin/coupons', requireAdmin, (req, res) => {
    const {
        code,
        description,
        discountType,
        discountValue,
        minPurchaseAmount = 0,
        maxUses,
        validFrom,
        validUntil
    } = req.body;

    const sql = `INSERT INTO coupons 
                 (code, description, discountType, discountValue, minPurchaseAmount, maxUses, validFrom, validUntil)
                 VALUES (?, ?, ?, ?, ?, ?, ?, ?)`;

    db.run(sql, [code, description, discountType, discountValue, minPurchaseAmount, maxUses, validFrom, validUntil],
        function (err) {
            if (err) {
                if (err.message.includes('UNIQUE constraint failed')) {
                    return res.status(400).json({ message: 'Coupon code already exists' });
                }
                return res.status(500).json({ error: err.message });
            }

            // Fetch the created coupon
            const selectSQL = 'SELECT * FROM coupons WHERE id = ?';
            db.get(selectSQL, [this.lastID], (err, coupon) => {
                if (err) {
                    return res.status(500).json({ error: err.message });
                }
                res.status(201).json(coupon);
            });
        });
});

// Update coupon (admin only)
app.put('/api/admin/coupons/:id', requireAdmin, (req, res) => {
    const { id } = req.params;
    const {
        code,
        description,
        discountType,
        discountValue,
        minPurchaseAmount,
        maxUses,
        validFrom,
        validUntil
    } = req.body;

    const updateTime = new Date().toISOString();

    const sql = `UPDATE coupons SET 
                 code = ?, description = ?, discountType = ?, discountValue = ?, 
                 minPurchaseAmount = ?, maxUses = ?, validFrom = ?, validUntil = ?, updatedAt = ?
                 WHERE id = ?`;

    db.run(sql, [code, description, discountType, discountValue, minPurchaseAmount, maxUses, validFrom, validUntil, updateTime, id],
        function (err) {
            if (err) {
                if (err.message.includes('UNIQUE constraint failed')) {
                    return res.status(400).json({ message: 'Coupon code already exists' });
                }
                return res.status(500).json({ error: err.message });
            }

            if (this.changes === 0) {
                return res.status(404).json({ message: 'Coupon not found' });
            }

            // Fetch the updated coupon
            const selectSQL = 'SELECT * FROM coupons WHERE id = ?';
            db.get(selectSQL, [id], (err, coupon) => {
                if (err) {
                    return res.status(500).json({ error: err.message });
                }
                res.json(coupon);
            });
        });
});

// Toggle coupon active status (admin only)
app.patch('/api/admin/coupons/:id/toggle', requireAdmin, (req, res) => {
    const { id } = req.params;
    const updateTime = new Date().toISOString();

    const sql = 'UPDATE coupons SET isActive = NOT isActive, updatedAt = ? WHERE id = ?';

    db.run(sql, [updateTime, id], function (err) {
        if (err) {
            return res.status(500).json({ error: err.message });
        }

        if (this.changes === 0) {
            return res.status(404).json({ message: 'Coupon not found' });
        }

        // Fetch the updated coupon
        const selectSQL = 'SELECT * FROM coupons WHERE id = ?';
        db.get(selectSQL, [id], (err, coupon) => {
            if (err) {
                return res.status(500).json({ error: err.message });
            }
            res.json(coupon);
        });
    });
});

// Delete coupon (admin only)
app.delete('/api/admin/coupons/:id', requireAdmin, (req, res) => {
    const { id } = req.params;

    const sql = 'DELETE FROM coupons WHERE id = ?';

    db.run(sql, [id], function (err) {
        if (err) {
            return res.status(500).json({ error: err.message });
        }

        if (this.changes === 0) {
            return res.status(404).json({ message: 'Coupon not found' });
        }

        res.json({ message: 'Coupon deleted successfully' });
    });
});

app.get('/api/licenses', (req, res) => {
    // Mock user ID from token
    const token = req.headers.authorization;
    if (!token) return res.json([]);
    const userId = token.replace('Bearer ', '').split('-').pop();

    const sql = `
        SELECT l.*, p.title, p.thumbnail, p.slug 
        FROM licenses l
        JOIN projects p ON l.projectId = p.id
        WHERE l.userId = ?
    `;
    db.all(sql, [userId], (err, rows) => {
        if (err) return res.status(500).json({ error: err.message });
        res.json(rows);
    });
});

app.listen(port, () => {
    console.log(`Server running at http://localhost:${port}`);
});
